default_config:

http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.1
  login_attempts_threshold: -1

auth_providers:
  - type: homeassistant
  - type: trusted_networks
    trusted_networks:
      - 127.0.0.1
      - 192.168.68.0/24
    allow_bypass_login: true
logger:
  default: info
  logs:
    custom_components.tibber_pulse_p1: debug
    homeassistant.components.influxdb: debug

influxdb:
  api_version: 2
  host: influxdb 
  port: 8086
  ssl: false
  verify_ssl: false
  token: !env_var INFLUXDB_TOKEN
  organization: !env_var INFLUXDB_ORG
  bucket: !env_var INFLUXDB_BUCKET
  tags:
    source: homeassistant
  include:
    domains:
      - sensor
      - binary_sensor
    entities:
      - sensor.olga_batteri
      - sensor.olga_nuvarande_rum
      - sensor.olga_status
      - sensor.olga_stadad_area
      - sensor.olga_total_stadtid
      - sensor.olga_totalt_antal_stadningar
      - sensor.olga_totalt_stadad_area
      - binary_sensor.olga_laddning
    entity_globs:
      - sensor.tibber*
      - sensor.b6559c39*
      - sensor.*tibber*
      - sensor.phase_*
      - sensor.dehumidifier_20l_*
      - sensor.ute_temp_*
      - sensor.overvoltage*
      - sensor.*heat_loss*
      - sensor.neutral*
      - sensor.total_active_power_sum
      - sensor.olga_*
      - binary_sensor.olga_*

template:
  - trigger:
      - platform: time_pattern
        minutes: "/5"
      - platform: state
        entity_id: climate.matforradet
    sensor:
      - name: "Matforradet Temperatur"
        unique_id: matforradet_temperatur
        unit_of_measurement: "C"
        state: >-
          {{ state_attr('climate.matforradet', 'current_temperature') | float(0) }}
        device_class: temperature
        state_class: measurement
  - sensor:
      - name: "Tibber Phase Current Imbalance"
        unique_id: tibber_phase_current_imbalance
        unit_of_measurement: "A"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set values = [l1, l2, l3] %}
          {{ (values|max - values|min) | round(2) }}
        device_class: power_factor
        state_class: measurement
      - name: "Tibber Phase Current Imbalance Percent"
        unique_id: tibber_phase_current_imbalance_percent
        unit_of_measurement: "%"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set values = [l1, l2, l3] %}
          {% set mean = (l1 + l2 + l3) / 3 if (l1 + l2 + l3) != 0 else 0 %}
          {% set diff = values|max - values|min %}
          {% if mean > 0 %}
            {{ ((diff / mean) * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Tibber Phase Voltage Imbalance"
        unique_id: tibber_phase_voltage_imbalance
        unit_of_measurement: "V"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set values = [v1, v2, v3] %}
          {{ (values|max - values|min) | round(2) }}
        device_class: power_factor
        state_class: measurement
      - name: "Tibber Phase Voltage Imbalance Percent"
        unique_id: tibber_phase_voltage_imbalance_percent
        unit_of_measurement: "%"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set values = [v1, v2, v3] %}
          {% set mean = (v1 + v2 + v3) / 3 if (v1 + v2 + v3) != 0 else 0 %}
          {% set diff = values|max - values|min %}
          {% if mean > 0 %}
            {{ ((diff / mean) * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Olga nuvarande rum"
        unique_id: olga_nuvarande_rum
        state: >-
          {{ state_attr('vacuum.olga', 'current_room') or 'unknown' }}
      - name: "Phase Current Imbalance Percent"
        unique_id: phase_current_imbalance_percent
        unit_of_measurement: "%"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set values = [l1, l2, l3] %}
          {% set mean = (l1 + l2 + l3) / 3 if (l1 + l2 + l3) != 0 else 0 %}
          {% set diff = values|max - values|min %}
          {% if mean > 0 %}
            {{ ((diff / mean) * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Voltage Imbalance Percent"
        unique_id: phase_voltage_imbalance_percent
        unit_of_measurement: "%"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set values = [v1, v2, v3] %}
          {% set mean = (v1 + v2 + v3) / 3 if (v1 + v2 + v3) != 0 else 0 %}
          {% set diff = values|max - values|min %}
          {% if mean > 0 %}
            {{ ((diff / mean) * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Overvoltage Alarm"
        unique_id: overvoltage_alarm
        unit_of_measurement: "count"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% if v1 > 253 or v2 > 253 or v3 > 253 %}1{% else %}0{% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Overvoltage Margin Max"
        unique_id: overvoltage_margin_max
        unit_of_measurement: "V"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set values = [v1, v2, v3] %}
          {{ (values|max - 253) | round(2) }}
        device_class: power_factor
        state_class: measurement
      - name: "Neutral Current Estimate"
        unique_id: neutral_current_estimate
        unit_of_measurement: "A"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set neutral = (l1*l1 + l2*l2 + l3*l3 - l1*l2 - l2*l3 - l3*l1) ** 0.5 %}
          {{ neutral | round(2) }}
        device_class: current
        state_class: measurement
      - name: "Neutral Heat Loss"
        unique_id: neutral_heat_loss
        unit_of_measurement: "W"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set neutral = (l1*l1 + l2*l2 + l3*l3 - l1*l2 - l2*l3 - l3*l1) ** 0.5 %}
          {% set r_neutral = 0.1 %}
          {{ (neutral * neutral * r_neutral) | round(2) }}
        device_class: power
        state_class: measurement
      - name: "Line Heat Loss"
        unique_id: line_heat_loss
        unit_of_measurement: "W"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set r_line = 0.1 %}
          {{ ((l1*l1 + l2*l2 + l3*l3) * r_line) | round(2) }}
        device_class: power
        state_class: measurement
      - name: "Phase Voltage Imbalance L1 Percent"
        unique_id: phase_voltage_imbalance_l1_percent
        unit_of_measurement: "%"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set mean = (v1 + v2 + v3) / 3 if (v1 + v2 + v3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((v1 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Voltage Imbalance L2 Percent"
        unique_id: phase_voltage_imbalance_l2_percent
        unit_of_measurement: "%"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set mean = (v1 + v2 + v3) / 3 if (v1 + v2 + v3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((v2 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Voltage Imbalance L3 Percent"
        unique_id: phase_voltage_imbalance_l3_percent
        unit_of_measurement: "%"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set mean = (v1 + v2 + v3) / 3 if (v1 + v2 + v3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((v3 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Current Imbalance L1 Percent"
        unique_id: phase_current_imbalance_l1_percent
        unit_of_measurement: "%"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((i1 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Current Imbalance L2 Percent"
        unique_id: phase_current_imbalance_l2_percent
        unit_of_measurement: "%"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((i2 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Current Imbalance L3 Percent"
        unique_id: phase_current_imbalance_l3_percent
        unit_of_measurement: "%"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((i3 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Total Active Power Sum"
        unique_id: total_active_power_sum
        unit_of_measurement: "W"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {{ (v1*i1 + v2*i2 + v3*i3) | round(1) }}
        device_class: power
        state_class: measurement
      - name: "Phase Power L1"
        unique_id: phase_power_l1
        unit_of_measurement: "W"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {{ (v1 * i1) | round(1) }}
        device_class: power
        state_class: measurement
      - name: "Phase Power L2"
        unique_id: phase_power_l2
        unit_of_measurement: "W"
        state: >-
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {{ (v2 * i2) | round(1) }}
        device_class: power
        state_class: measurement
      - name: "Phase Power L3"
        unique_id: phase_power_l3
        unit_of_measurement: "W"
        state: >-
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {{ (v3 * i3) | round(1) }}
        device_class: power
        state_class: measurement
      - name: "Neutral Current L1 Estimate"
        unique_id: neutral_current_l1
        unit_of_measurement: "A"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {{ (i1 - mean) | abs | round(2) }}
        device_class: current
        state_class: measurement
      - name: "Neutral Current L2 Estimate"
        unique_id: neutral_current_l2
        unit_of_measurement: "A"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {{ (i2 - mean) | abs | round(2) }}
        device_class: current
        state_class: measurement
      - name: "Neutral Current L3 Estimate"
        unique_id: neutral_current_l3
        unit_of_measurement: "A"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {{ (i3 - mean) | abs | round(2) }}
        device_class: current
        state_class: measurement
      - name: "Line Heat Loss L1"
        unique_id: line_heat_loss_l1
        unit_of_measurement: "W"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set r_line = 0.1 %}
          {{ (i1 * i1 * r_line) | round(2) }}
        device_class: power
        state_class: measurement
      - name: "Line Heat Loss L2"
        unique_id: line_heat_loss_l2
        unit_of_measurement: "W"
        state: >-
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set r_line = 0.1 %}
          {{ (i2 * i2 * r_line) | round(2) }}
        device_class: power
        state_class: measurement
      - name: "Line Heat Loss L3"
        unique_id: line_heat_loss_l3
        unit_of_measurement: "W"
        state: >-
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set r_line = 0.1 %}
          {{ (i3 * i3 * r_line) | round(2) }}
        device_class: power
        state_class: measurement
  - sensor:
      - name: "Olga nuvarande rum"
        unique_id: olga_nuvarande_rum
        state: >-
          {{ state_attr('vacuum.olga', 'current_room') or 'unknown' }}
automation: !include automations.yaml

notify:
  - platform: smtp
    name: gmail
    server: smtp.gmail.com
    port: 587
    encryption: starttls
    timeout: 15
    sender: hojtaminolta@gmail.com
    username: hojtaminolta@gmail.com
    password: !secret gmail_app_password
    recipient:
      - frollep@gmail.com
