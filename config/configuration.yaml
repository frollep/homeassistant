default_config:

http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.1
  login_attempts_threshold: -1

auth_providers:
  - type: homeassistant
  - type: trusted_networks
    trusted_networks:
      - 127.0.0.1
      - 192.168.68.0/24
    allow_bypass_login: true
logger:
  default: info
  logs:
    custom_components.tibber_pulse_p1: debug
    homeassistant.components.influxdb: debug

influxdb:
  api_version: 2
  host: influxdb 
  port: 8086
  ssl: false
  verify_ssl: false
  token: !env_var INFLUXDB_TOKEN
  organization: !env_var INFLUXDB_ORG
  bucket: !env_var INFLUXDB_BUCKET
  tags:
    source: homeassistant
  include:
    domains:
      - sensor
      - binary_sensor
      - lock
    entities:
      - sensor.olga_batteri
      - sensor.olga_nuvarande_rum
      - sensor.olga_status
      - sensor.olga_stadad_area
      - sensor.olga_total_stadtid
      - sensor.olga_totalt_antal_stadningar
      - sensor.olga_totalt_stadad_area
      - sensor.outdoor_smart_plug_effekt
      - sensor.outdoor_smart_plug_2_effekt
      - sensor.olga_nuvarande_rum_kod
      - sensor.ute_temp_batteristatus
      - sensor.ute_temp_batteri_procent
      - lock.ytterdorr
      - sensor.ytterdorr_las_status
      - sensor.motorvarmare_energi_stabil
      - sensor.utebelysning_energi_stabil
      - binary_sensor.olga_laddning
    entity_globs:
      - sensor.tibber*
      - sensor.b6559c39*
      - sensor.*tibber*
      - sensor.phase_*
      - sensor.outdoor_smart_plug_*
      - sensor.outdoor_smart_plug_2_*
      - sensor.dehumidifier_20l_*
      - sensor.ute_temp_*
      - sensor.overvoltage*
      - sensor.*heat_loss*
      - sensor.neutral*
      - sensor.total_active_power_sum
      - sensor.olga_*
      - binary_sensor.olga_*

template:
  - trigger:
      - platform: time_pattern
        minutes: "/5"
      - platform: state
        entity_id: climate.matforradet
    sensor:
      - name: "Matforradet Temperatur"
        unique_id: matforradet_temperatur
        unit_of_measurement: "C"
        state: >-
          {{ state_attr('climate.matforradet', 'current_temperature') | float(0) }}
        device_class: temperature
        state_class: measurement
  - trigger:
      - platform: time_pattern
        minutes: "/1"
      - platform: state
        entity_id: sensor.olga_status
      - platform: state
        entity_id:
          - sensor.tibber_pulse_gnejsarn_spanning_fas1
          - sensor.tibber_pulse_gnejsarn_spanning_fas2
          - sensor.tibber_pulse_gnejsarn_spanning_fas3
          - sensor.tibber_pulse_gnejsarn_strom_fas1
          - sensor.tibber_pulse_gnejsarn_strom_fas2
          - sensor.tibber_pulse_gnejsarn_strom_fas3
    sensor:
      - name: "Olga Status Code"
        unique_id: olga_status_code
        state_class: measurement
        state: >-
          {% set status = states('sensor.olga_status') | lower %}
          {% if status == 'charging' %}
            {% set code = 1 %}
          {% elif status == 'docked' %}
            {% set code = 2 %}
          {% elif 'cleaning' in status or 'mopping' in status %}
            {% set code = 3 %}
          {% elif status == 'returning_home' or status == 'returning' or 'returning' in status %}
            {% set code = 4 %}
          {% elif status == 'paused' %}
            {% set code = 5 %}
          {% elif status == 'idle' %}
            {% set code = 6 %}
          {% elif status == 'device_offline' %}
            {% set code = 97 %}
          {% elif status == 'charging_problem' %}
            {% set code = 98 %}
          {% elif status == 'error' %}
            {% set code = 99 %}
          {% else %}
            {% set code = 0 %}
          {% endif %}
          {{ (code + (now().minute / 1000)) | round(3) }}
      - name: "Tibber Phase Current Imbalance"
        unique_id: tibber_phase_current_imbalance
        unit_of_measurement: "A"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set values = [l1, l2, l3] %}
          {{ (values|max - values|min) | round(2) }}
        device_class: power_factor
        state_class: measurement
      - name: "Tibber Phase Current Imbalance Percent"
        unique_id: tibber_phase_current_imbalance_percent
        unit_of_measurement: "%"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set values = [l1, l2, l3] %}
          {% set mean = (l1 + l2 + l3) / 3 if (l1 + l2 + l3) != 0 else 0 %}
          {% set diff = values|max - values|min %}
          {% if mean > 0 %}
            {{ ((diff / mean) * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Tibber Phase Voltage Imbalance"
        unique_id: tibber_phase_voltage_imbalance
        unit_of_measurement: "V"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set values = [v1, v2, v3] %}
          {{ (values|max - values|min) | round(2) }}
        device_class: power_factor
        state_class: measurement
      - name: "Tibber Phase Voltage Imbalance Percent"
        unique_id: tibber_phase_voltage_imbalance_percent
        unit_of_measurement: "%"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set values = [v1, v2, v3] %}
          {% set mean = (v1 + v2 + v3) / 3 if (v1 + v2 + v3) != 0 else 0 %}
          {% set diff = values|max - values|min %}
          {% if mean > 0 %}
            {{ ((diff / mean) * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Olga nuvarande rum"
        unique_id: olga_nuvarande_rum
        state: >-
          {{ state_attr('vacuum.olga', 'current_room') or 'unknown' }}
      - name: "Phase Current Imbalance Percent"
        unique_id: phase_current_imbalance_percent
        unit_of_measurement: "%"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set values = [l1, l2, l3] %}
          {% set mean = (l1 + l2 + l3) / 3 if (l1 + l2 + l3) != 0 else 0 %}
          {% set diff = values|max - values|min %}
          {% if mean > 0 %}
            {{ ((diff / mean) * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Voltage Imbalance Percent"
        unique_id: phase_voltage_imbalance_percent
        unit_of_measurement: "%"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set values = [v1, v2, v3] %}
          {% set mean = (v1 + v2 + v3) / 3 if (v1 + v2 + v3) != 0 else 0 %}
          {% set diff = values|max - values|min %}
          {% if mean > 0 %}
            {{ ((diff / mean) * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Overvoltage Alarm"
        unique_id: overvoltage_alarm
        unit_of_measurement: "count"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% if v1 > 253 or v2 > 253 or v3 > 253 %}1{% else %}0{% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Overvoltage Margin Max"
        unique_id: overvoltage_margin_max
        unit_of_measurement: "V"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set values = [v1, v2, v3] %}
          {{ (values|max - 253) | round(2) }}
        device_class: power_factor
        state_class: measurement
      - name: "Neutral Current Estimate"
        unique_id: neutral_current_estimate
        unit_of_measurement: "A"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set neutral = (l1*l1 + l2*l2 + l3*l3 - l1*l2 - l2*l3 - l3*l1) ** 0.5 %}
          {{ neutral | round(2) }}
        device_class: current
        state_class: measurement
      - name: "Neutral Heat Loss"
        unique_id: neutral_heat_loss
        unit_of_measurement: "W"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set neutral = (l1*l1 + l2*l2 + l3*l3 - l1*l2 - l2*l3 - l3*l1) ** 0.5 %}
          {% set r_neutral = 0.1 %}
          {{ (neutral * neutral * r_neutral) | round(2) }}
        device_class: power
        state_class: measurement
      - name: "Line Heat Loss"
        unique_id: line_heat_loss
        unit_of_measurement: "W"
        state: >-
          {% set l1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set l2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set l3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set r_line = 0.1 %}
          {{ ((l1*l1 + l2*l2 + l3*l3) * r_line) | round(2) }}
        device_class: power
        state_class: measurement
      - name: "Phase Voltage Imbalance L1 Percent"
        unique_id: phase_voltage_imbalance_l1_percent
        unit_of_measurement: "%"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set mean = (v1 + v2 + v3) / 3 if (v1 + v2 + v3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((v1 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Voltage Imbalance L2 Percent"
        unique_id: phase_voltage_imbalance_l2_percent
        unit_of_measurement: "%"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set mean = (v1 + v2 + v3) / 3 if (v1 + v2 + v3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((v2 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Voltage Imbalance L3 Percent"
        unique_id: phase_voltage_imbalance_l3_percent
        unit_of_measurement: "%"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set mean = (v1 + v2 + v3) / 3 if (v1 + v2 + v3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((v3 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Current Imbalance L1 Percent"
        unique_id: phase_current_imbalance_l1_percent
        unit_of_measurement: "%"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((i1 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Current Imbalance L2 Percent"
        unique_id: phase_current_imbalance_l2_percent
        unit_of_measurement: "%"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((i2 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Phase Current Imbalance L3 Percent"
        unique_id: phase_current_imbalance_l3_percent
        unit_of_measurement: "%"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {% if mean > 0 %}
            {{ ((i3 - mean) / mean * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        device_class: power_factor
        state_class: measurement
      - name: "Total Active Power Sum"
        unique_id: total_active_power_sum
        unit_of_measurement: "W"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {{ (v1*i1 + v2*i2 + v3*i3) | round(1) }}
        device_class: power
        state_class: measurement
      - name: "Phase Power L1"
        unique_id: phase_power_l1
        unit_of_measurement: "W"
        state: >-
          {% set v1 = states('sensor.tibber_pulse_gnejsarn_spanning_fas1')|float(0) %}
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {{ (v1 * i1) | round(1) }}
        device_class: power
        state_class: measurement
      - name: "Phase Power L2"
        unique_id: phase_power_l2
        unit_of_measurement: "W"
        state: >-
          {% set v2 = states('sensor.tibber_pulse_gnejsarn_spanning_fas2')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {{ (v2 * i2) | round(1) }}
        device_class: power
        state_class: measurement
      - name: "Phase Power L3"
        unique_id: phase_power_l3
        unit_of_measurement: "W"
        state: >-
          {% set v3 = states('sensor.tibber_pulse_gnejsarn_spanning_fas3')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {{ (v3 * i3) | round(1) }}
        device_class: power
        state_class: measurement
      - name: "Neutral Current L1 Estimate"
        unique_id: neutral_current_l1
        unit_of_measurement: "A"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {{ (i1 - mean) | abs | round(2) }}
        device_class: current
        state_class: measurement
      - name: "Neutral Current L2 Estimate"
        unique_id: neutral_current_l2
        unit_of_measurement: "A"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {{ (i2 - mean) | abs | round(2) }}
        device_class: current
        state_class: measurement
      - name: "Neutral Current L3 Estimate"
        unique_id: neutral_current_l3
        unit_of_measurement: "A"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set mean = (i1 + i2 + i3) / 3 if (i1 + i2 + i3) != 0 else 0 %}
          {{ (i3 - mean) | abs | round(2) }}
        device_class: current
        state_class: measurement
      - name: "Line Heat Loss L1"
        unique_id: line_heat_loss_l1
        unit_of_measurement: "W"
        state: >-
          {% set i1 = states('sensor.tibber_pulse_gnejsarn_strom_fas1')|float(0) %}
          {% set r_line = 0.1 %}
          {{ (i1 * i1 * r_line) | round(2) }}
        device_class: power
        state_class: measurement
      - name: "Line Heat Loss L2"
        unique_id: line_heat_loss_l2
        unit_of_measurement: "W"
        state: >-
          {% set i2 = states('sensor.tibber_pulse_gnejsarn_strom_fas2')|float(0) %}
          {% set r_line = 0.1 %}
          {{ (i2 * i2 * r_line) | round(2) }}
        device_class: power
        state_class: measurement
      - name: "Line Heat Loss L3"
        unique_id: line_heat_loss_l3
        unit_of_measurement: "W"
        state: >-
          {% set i3 = states('sensor.tibber_pulse_gnejsarn_strom_fas3')|float(0) %}
          {% set r_line = 0.1 %}
          {{ (i3 * i3 * r_line) | round(2) }}
        device_class: power
        state_class: measurement
  - sensor:
      - name: "Olga nuvarande rum"
        unique_id: olga_nuvarande_rum
        state: >-
          {{ state_attr('vacuum.olga', 'current_room') or 'unknown' }}
  - trigger:
      - platform: homeassistant
        event: start
      - platform: state
        entity_id: sensor.olga_nuvarande_rum
      - platform: time_pattern
        minutes: "/1"
    sensor:
      - name: "Olga nuvarande rum kod"
        unique_id: olga_nuvarande_rum_kod
        state_class: measurement
        unit_of_measurement: "count"
        state: >-
          {% set room = states('sensor.olga_nuvarande_rum') | lower %}
          {% if room == 'trappen' %}
            1
          {% elif room == 'vardagsrummet' %}
            2
          {% elif room == 'kontoret' %}
            3
          {% elif room == 'hallen' %}
            4
          {% elif room == 'köket' or room == 'koket' %}
            5
          {% else %}
            0
          {% endif %}
  - trigger:
      - platform: homeassistant
        event: start
      - platform: state
        entity_id: sensor.ute_temp_batteristatus
      - platform: time_pattern
        minutes: "/15"
    sensor:
      - name: "Ute temp batteri procent"
        unique_id: ute_temp_batteri_procent
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        state: >-
          {% set raw = states('sensor.ute_temp_batteristatus') | lower %}
          {% if raw in ['high', 'hög', 'hog'] %}
            90
          {% elif raw in ['medium', 'middle', 'medel'] %}
            50
          {% elif raw in ['low', 'låg', 'lag'] %}
            20
          {% else %}
            0
          {% endif %}
  - trigger:
      - platform: homeassistant
        event: start
      - platform: state
        entity_id: lock.ytterdorr
      - platform: time_pattern
        minutes: "/1"
    sensor:
      - name: "Ytterdörr lås status"
        unique_id: ytterdorr_las_status
        unit_of_measurement: "count"
        state_class: measurement
        state: >-
          {% set s = states('lock.ytterdorr') | lower %}
          {% if s == 'locked' %}
            1
          {% elif s == 'unlocked' %}
            0
          {% else %}
            0
          {% endif %}
  - sensor:
      - name: "Motorvarmare energi stabil"
        unique_id: motorvarmare_energi_stabil
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total_increasing
        state: >-
          {% set current = states('sensor.outdoor_smart_plug_total_energi') | float(0) %}
          {% set previous = this.state | float(0) %}
          {{ [current, previous] | max }}
      - name: "Utebelysning energi stabil"
        unique_id: utebelysning_energi_stabil
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total_increasing
        state: >-
          {% set current = states('sensor.outdoor_smart_plug_2_total_energi') | float(0) %}
          {% set previous = this.state | float(0) %}
          {{ [current, previous] | max }}
automation: !include automations.yaml

notify:
  - platform: smtp
    name: gmail
    server: smtp.gmail.com
    port: 587
    encryption: starttls
    timeout: 15
    sender: hojtaminolta@gmail.com
    username: hojtaminolta@gmail.com
    password: !secret gmail_app_password
    recipient:
      - frollep@gmail.com
